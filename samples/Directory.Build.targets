<Project>
  <PropertyGroup>
    <!-- Default to true to improve inner-loop dev experience -->
    <UseLocalArkToolsSources Condition="'$(UseLocalArkToolsSources)' == ''">true</UseLocalArkToolsSources>
    <!-- Define root relative to this file (samples/) -->
    <ArkToolsSourceRoot>$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)..\src\'))</ArkToolsSourceRoot>
  </PropertyGroup>

  <!-- When using local sources, we must disable lock file restore because the dependencies change -->
  <!-- We redirect the lock file to the intermediate folder to avoid the error NU1005 (lock file exists but usage disabled) -->
  <PropertyGroup Condition="'$(UseLocalArkToolsSources)' == 'true'">
    <RestorePackagesWithLockFile>true</RestorePackagesWithLockFile>
    <RestoreLockedMode>false</RestoreLockedMode>
    <NuGetLockFilePath>$(BaseIntermediateOutputPath)packages.lock.json</NuGetLockFilePath>
  </PropertyGroup>

  <!-- Use a Target to avoid MSB4191 (custom metadata in Condition in top-level ItemGroup) -->
  <Target Name="_ReplaceArkToolsReferences" BeforeTargets="CollectPackageReferences" Condition="'$(UseLocalArkToolsSources)' == 'true'">
      <ItemGroup>
         <_ArkToolsCandidates Include="@(PackageReference)" Condition="$([System.String]::Copy('%(Identity)').StartsWith('Ark.Tools'))">
            <CommonPath>$(ArkToolsSourceRoot)common\%(Identity)\%(Identity).csproj</CommonPath>
            <AspNetCorePath>$(ArkToolsSourceRoot)aspnetcore\%(Identity)\%(Identity).csproj</AspNetCorePath>
            <ResourceWatcherPath>$(ArkToolsSourceRoot)resourcewatcher\%(Identity)\%(Identity).csproj</ResourceWatcherPath>
         </_ArkToolsCandidates>
      </ItemGroup>
      
      <ItemGroup>
         <_ArkToolsToReplace Include="@(_ArkToolsCandidates)" Condition="Exists('%(CommonPath)')">
            <ProjectPath>%(CommonPath)</ProjectPath>
         </_ArkToolsToReplace>
         <_ArkToolsToReplace Include="@(_ArkToolsCandidates)" Condition="Exists('%(AspNetCorePath)')">
            <ProjectPath>%(AspNetCorePath)</ProjectPath>
         </_ArkToolsToReplace>
         <_ArkToolsToReplace Include="@(_ArkToolsCandidates)" Condition="Exists('%(ResourceWatcherPath)')">
            <ProjectPath>%(ResourceWatcherPath)</ProjectPath>
         </_ArkToolsToReplace>
      </ItemGroup>

      <ItemGroup>
         <PackageReference Remove="@(_ArkToolsToReplace)" />
         <ProjectReference Include="@(_ArkToolsToReplace->'%(ProjectPath)')" />
      </ItemGroup>

      <Message Text="[Ark.Tools] Replaced PackageReference with ProjectReference for: @(_ArkToolsToReplace)" Importance="High" />
  </Target>

</Project>